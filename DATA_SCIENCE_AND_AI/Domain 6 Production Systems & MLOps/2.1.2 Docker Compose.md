
# 1. Docker compose 

## 1.1 Remove docker hoặc remove port 

```bash
docker stop redis
docker remove redis
```

```bash
*5. Kiểm tra process nào đang sử dụng port 30000:**

	sudo lsof -i :30000

( "Super User Do - List Open Files - Internet connections on port 9433" (Dùng quyền admin để liệt kê process nào đang sử dụng port 9433))
**6. Kill process theo PID (nếu có):**

sudo kill -9 <PID>


**7. Hoặc kill tất cả process trên port 30000:**

sudo fuser -k 30000/tcp

```

# 1. **Phân biệt restart: always và restart: unless-stopped trong Docker Compose:**

| Thuộc tính                                                 | **always**                                                         | **unless-stopped**                                                           |
| ---------------------------------------------------------- | ------------------------------------------------------------------ | ---------------------------------------------------------------------------- |
| Khi container lỗi (exited bất thường)                      | Luôn tự động restart                                               | Luôn tự động restart                                                         |
| Khi container down do lệnh `docker restart` hoặc OS reboot | Tự động start lại khi Docker hoặc server khởi động lại             | Tự động start lại khi Docker hoặc server khởi động lại                       |
| Khi **bạn tự stop bằng `docker stop ...`**                 | **Lần sau Docker hoặc OS restart vẫn tự động start lại container** | **Lần sau Docker hoặc OS restart thì container KHÔNG tự động khởi động lại** |
| Khi dùng `docker compose down`                             | Không còn container nên không restart                              | Không còn container nên không restart                                        |

**Tóm gọn:**

- `restart: always`: Container luôn tự start lại mọi trường hợp (trừ khi bị xóa).
    
- `restart: unless-stopped`: Container sẽ luôn start lại, **trừ khi bạn từng stop thủ công**, khi đó sẽ KHÔNG tự start lại nữa cho đến khi bạn tự chạy lại nó.
    

**Khi nên dùng cái nào?**

- Nếu muốn container luôn được Docker đảm bảo hoạt động, kể cả sau stop thủ công, hãy dùng `always`.
    
- Nếu chỉ muốn container restart lại khi lỗi hoặc OS reboot, **KHÔNG phải sau khi bạn chủ động stop** (ví dụ để bảo trì), chọn `unless-stopped`.
    

1. [https://www.perplexity.ai/search/redis-hoc-ve-redis-HtFbAlR9QPWeKOnOA7dRiw](https://www.perplexity.ai/search/redis-hoc-ve-redis-HtFbAlR9QPWeKOnOA7dRiw)


# 2. Câu hỏi về: --remove-orphans và vấn đề khi deploy 2 file docker compose kèm --remove-orphans thì bị mất 1 cái docker compose kia => Giải pháp: đặt project name cho từng file docker compose 
  
@deploy/  
  
Khi mình chạy deploy docker compose 2 file riêng ở trong cùng 1 thư mục là @docker-compose.prod.yaml và @docker-compose.redis.yaml  
  
thì nó báo là: WARN[0090] Found orphan containers ([redisinsight redis]) for this project. If you removed or renamed this service in your compose file, you can run this command with the --remove-orphans flag to clean it up.  
  
  
ý nghĩa điều này là gì? Vì nếu tôi thêm --remove-orphans thì nó lại bị mất cái của docker compose kia

## Ý nghĩa của warning message

**Orphan containers** là những containers đang chạy nhưng không được định nghĩa trong file docker-compose hiện tại. Trong trường hợp của bạn:

- Khi chạy `docker-compose.prod.yaml`, Docker Compose chỉ biết về service `api`
- Nhưng nó phát hiện có containers `redis` và `redisinsight` đang chạy trong cùng project
- Vì những containers này không được khai báo trong `docker-compose.prod.yaml`, nên chúng được coi là "orphan"

## Tại sao `--remove-orphans` không phải giải pháp tốt

Khi bạn dùng `--remove-orphans`, Docker Compose sẽ xóa tất cả containers không được định nghĩa trong file hiện tại, bao gồm cả `redis` và `redisinsight` từ file kia.

## Giải pháp tốt nhất: Sử dụng project name riêng biệt

Thay vì để Docker Compose tự động tạo project name (dựa trên tên thư mục), hãy chỉ định project name riêng cho mỗi file:


[2 tools called]

## Cách chạy sau khi cập nhật

Bây giờ bạn có thể chạy từng file độc lập mà không gặp warning:

```bash
# Chạy Redis services
docker-compose -f docker-compose.redis.yaml up -d

# Chạy API service  
docker-compose -f docker-compose.prod.yaml up -d
```

## Lợi ích của giải pháp này

1. **Tách biệt hoàn toàn**: Mỗi project được quản lý độc lập
2. **Không có orphan containers**: Mỗi project chỉ quản lý containers của riêng mình
3. **Dễ dàng quản lý**: Có thể start/stop từng service riêng biệt
4. **Không cần `--remove-orphans`**: Không còn warning message

## Lưu ý về networking

Nếu API service cần kết nối đến Redis, bạn cần cấu hình external network hoặc sử dụng host networking. Hiện tại hai project này sẽ có network riêng biệt.

Bạn có muốn tôi cấu hình network để API có thể kết nối đến Redis không?



# 3. Về network của docker compose ? và best practices 

- Khi không khai báo gì phần `networks` ở cuối file, Docker Compose tự động tạo một mạng mặc định có tên `[projectname]_default` với kiểu `bridge` cho cả ứng dụng.[](https://minhnv2306.github.io/2020/04/21/Docker-Networking-in-Compose/)
    
- Tất cả các service trong file Compose sẽ tham gia vào mạng này và có thể giao tiếp lẫn nhau qua tên container.[](https://docs.docker.com/compose/how-tos/networking/)
    
- Việc khai báo phần `networks` ở cuối chỉ cần thiết khi muốn dùng custom network (tự đặt subnet, gateway, driver đặc biệt, hoặc dùng external network).[](https://viblo.asia/p/docker-networking-nhung-khai-niem-va-cach-su-dung-co-ban-gGJ59P2JlX2)
    
- Nếu vẫn khai báo custom network mà service không được gán vào, nó vẫn dùng default network, còn mạng custom sẽ không được sử dụng.


1. [https://viblo.asia/p/docker-compose-file-co-gi-EvbLbxnP4nk](https://viblo.asia/p/docker-compose-file-co-gi-EvbLbxnP4nk)
2. [https://demanejar.github.io/posts/Docker/](https://demanejar.github.io/posts/Docker/)
3. [https://viblo.asia/p/docker-networking-nhung-khai-niem-va-cach-su-dung-co-ban-gGJ59P2JlX2](https://viblo.asia/p/docker-networking-nhung-khai-niem-va-cach-su-dung-co-ban-gGJ59P2JlX2)
4. [https://tuyendung.evotek.vn/roadmap-docker-quan-ly-ung-dung-da-container-voi-docker-compose/](https://tuyendung.evotek.vn/roadmap-docker-quan-ly-ung-dung-da-container-voi-docker-compose/)
5. [https://minhnv2306.github.io/2020/04/21/Docker-Networking-in-Compose/](https://minhnv2306.github.io/2020/04/21/Docker-Networking-in-Compose/)
6. [https://docs.docker.com/compose/how-tos/networking/](https://docs.docker.com/compose/how-tos/networking/)
7. [https://forums.docker.com/t/set-default-network-name-for-compose/36779](https://forums.docker.com/t/set-default-network-name-for-compose/36779)
8. [https://www.alibabacloud.com/blog/599917](https://www.alibabacloud.com/blog/599917)
9. [https://2coffee.dev/bai-viet/series-ve-docker-trong-thuc-hanh-va-san-xuat-network-trong-docker](https://2coffee.dev/bai-viet/series-ve-docker-trong-thuc-hanh-va-san-xuat-network-trong-docker)
10. [https://ttth.tlu.edu.vn/docker-compose-va-nhung-kien-thuc-co-ban](https://ttth.tlu.edu.vn/docker-compose-va-nhung-kien-thuc-co-ban)

# 4.  Name network (thay vì tự động bị đặt tên thành: folder name-default => thì mình chủ động đặt tên cho nó) và vấn đề hết dải subnet và vấn đề 2 docker compose khởi tạo cùng subnet 

```
=> CACHED [intent-api 8/10] RUN pip3 install --no-cache-dir --upgrade pip && pip3 install --no-cache-dir -r /app/requi 0.0s => CACHED [intent-api 9/10] COPY src/ /app/src/ 0.0s => CACHED [intent-api 10/10] RUN mkdir -p /app/src/logs 0.0s => [intent-api] exporting to image 0.0s => => exporting layers 0.0s => => writing image sha256:f82813ab1604d9c58868f6d27b9ac37fdf15a01eb3c227088b45a42362d255f4 0.0s => => naming to docker.io/library/miniprod_nlp2_intentclassification_mappingfastresponse_t1_2025_stepupeducation-intent-api 0.0s [+] Running 1/0 ✘ Network miniprod_nlp2_intentclassification_mappingfastresponse_t1_2025_stepupeducation_intent-network Error 0.0s failed to create network miniprod_nlp2_intentclassification_mappingfastresponse_t1_2025_stepupeducation_intent-network: Error response from daemon: could not find an available, non-overlapping IPv4 address pool among the defaults to assign to the network θ73° [ubuntu@mgc-dev2-3090:~/truc_ai/MiniProd_NLP2_IntentClassification_MappingFastResponse_T1_2025_StepUpEducation/src] master(+10/-4)* ± Lỗi gì đây nhỉ
```

## 1. Vấn đề gặp phải

### Lỗi chính

```
failed to create network miniprod_nlp2_intentclassification_mappingfastresponse_t1_2025_stepupeducation_intent-network: 
Error response from daemon: could not find an available, non-overlapping IPv4 address pool among the defaults to assign to the network
```

### Triệu chứng

- Docker Compose không thể tạo custom network mới
- Container build thành công nhưng không thể start do lỗi network
- Lỗi xảy ra liên tục dù đã thử docker network prune

### Nguyên nhân gốc rễ

Docker daemon đã cạn kiệt các dải IP khả dụng do có quá nhiều networks đang tồn tại trên hệ thống.

## 2. Kiểm tra các mạng hiện tại

### Network inventory

Hệ thống hiện có **30+ Docker networks** đang hoạt động:

```bash
$ docker network ls
NETWORK ID     NAME                                                                   DRIVER    SCOPE
1ee83a85e17e   ai-agent-coach_robot-ai-workflow-network-master                        bridge    local
01684692a642   ai-agent-master_robot-ai-workflow-network-master                       bridge    local
22a276825d4a   ai-agent-noti_robot-ai-workflow-network-master                         bridge    local
b4815173bfb5   ai-agent-router-dev_robot-ai-workflow-network-master                   bridge    local
# ... và 25+ networks khác
```

```bash
docker network ls -q | xargs -n1 docker network inspect --format '{{.Name}}: {{range .IPAM.Config}}{{.Subnet}} (gw {{.Gateway}}){{end}}'

```

```
θ74° [ubuntu@mgc-dev2-3090:~/cuong_dn/robot-lesson-workflow/utils/UI] manual-refactor-agent-registry(+9/-4)+* ± docker network ls -q | xargs -n1 docker network inspect --format '{{.Name}}: {{range .IPAM.Config}}{{.Subnet}} (gw {{.Gateway}}){{end}}'
ai-agent-coach_robot-ai-workflow-network-master: 192.168.160.0/20 (gw 192.168.160.1)
ai-agent-master_robot-ai-workflow-network-master: 172.22.0.0/16 (gw 172.22.0.1)
ai-agent-noti_robot-ai-workflow-network-master: 172.24.0.0/16 (gw 172.24.0.1)
ai-agent-router-dev_robot-ai-workflow-network-master: 192.168.224.0/20 (gw 192.168.224.1)
ai-agent-router_robot-ai-workflow-network-master: 192.168.144.0/20 (gw 192.168.144.1)
ai_service_default: 172.23.0.0/16 (gw 172.23.0.1)
bridge: 172.17.0.0/16 (gw 172.17.0.1)
deploy_default: 172.31.0.0/16 (gw 172.31.0.1)
deployapi_server_default: 192.168.192.0/20 (gw 192.168.192.1)
deployproduction_intent_network: 192.168.128.0/20 (gw 192.168.128.1)
dify_default_dev: 192.168.176.0/20 (gw 192.168.176.1)
dify_ssrf_proxy_network_dev: 192.168.112.0/20 (gw 192.168.112.1)
docker_default: 172.25.0.0/16 (gw 172.25.0.1)
docker_ssrf_proxy_network: 192.168.240.0/20 (gw 192.168.240.1)
host: 
kokoro_default: 172.26.0.0/16 (gw 172.26.0.1)
langfuse_default: 170.28.0.0/24 (gw )
langgraph_n8n_langgraph-n8n-network-master: 172.19.0.0/16 (gw 172.19.0.1)
legal_rag: 192.168.80.0/20 (gw 192.168.80.1)
lesson-builder-backend_web: 170.26.0.0/24 (gw )
ls_ai_automation_default: 172.28.0.0/16 (gw 172.28.0.1)
milvus: 172.21.0.0/16 (gw 172.21.0.1)
miniprod_nlp2_intentclassification_mappingfastresponse_t1_2025_stepupeducation_intent-network: 10.20.0.0/24 (gw 10.20.0.1)
n8n_n8n-services-network-master: 172.18.0.0/16 (gw 172.18.0.1)
none: 
personalized-ai-coach-dev_robot-ai-workflow-network-master: 192.168.64.0/20 (gw 192.168.64.1)
personalized-ai-coach_robot-ai-workflow-network-master: 192.168.32.0/20 (gw 192.168.32.1)
prod_deploy_default: 172.29.0.0/16 (gw 172.29.0.1)
robot-ai-lesson_robot-ai-workflow-network-master: 192.168.48.0/20 (gw 192.168.48.1)
robot-ai-service_default: 172.27.0.0/16 (gw 172.27.0.1)
robot-ai-workflow-dev_robot-ai-workflow-network-dev: 172.30.0.0/16 (gw 172.30.0.1)
robot-ai-workflow_robot-ai-workflow-network-master: 192.168.0.0/20 (gw 192.168.0.1)
robot-lesson-workflow-dev_studio-ai-platform-workflow-network-master: 192.168.16.0/20 (gw 192.168.16.1)
tool_su_table_to_json_default: 192.168.208.0/20 (gw 192.168.208.1)
vioedu_vioedu-generator-math-network: 192.168.96.0/20 (gw 192.168.96.1)
voicetrans_voicetrans_app: 172.20.0.0/16 (gw 172.20.0.1)
θ74° [ubuntu@mgc-dev2-3090:~/cuong_dn/robot-lesson-workflow/utils/UI] manual-refactor-agent-registry(+9/-4)+* ± 
```
### IP Range Analysis

Từ `ip route` output, các dải IP đang được sử dụng:

**172.x.x.x networks:**

- 172.17.0.0/16 (docker0 - default bridge)
- 172.18.0.0/16 đến 172.31.0.0/16 (14 networks)

**192.168.x.x networks:**

- 192.168.0.0/20 đến 192.168.240.0/20 (16 networks)

**170.x.x.x networks:**

- 170.26.0.0/24, 170.28.0.0/24

**Tổng cộng: 32 active networks** sử dụng hầu hết các dải IP mặc định của Docker.

## 3. Giải pháp được áp dụng

### Bước 1: Cleanup cơ bản

```bash
# Thử dọn dẹp networks không sử dụng
docker network prune -f
# Kết quả: Không có network nào bị xóa (tất cả đều đang được sử dụng)
```

### Bước 2: Chỉnh sửa Network Configuration

#### Docker Compose Configuration mới:

```yaml
version: '3.8'

services:
  intent-api:
    build: .
    container_name: intent-classification-api
    ports:
      - "20012:20012"
    env_file:
      - .env
    volumes:
      # Model persistence
      - ./src/exported_models:/app/src/exported_models
      - ./src/trained_models:/app/src/trained_models
      # Response files
      - ./src/intent_reponse.json:/app/src/intent_reponse.json
      - ./src/intent_reponse_v2.json:/app/src/intent_reponse_v2.json
      - ./src/fixed_response.json:/app/src/fixed_response.json
      # Logs
      - ./logs:/app/src/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:20012/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    runtime: nvidia
    networks:
      - intent-network

networks:
  intent-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.10.0.0/24
          gateway: 10.10.0.1
```

#### Các dải nào có thể được dùng 

- Dải: `10.10.0.0/24` → IP usable: `10.10.0.1` → `10.10.0.254`
- Gateway (cổng ra mạng) phải là một địa chỉ IP hợp lệ **trong khoảng 10.10.0.1 đến 10.10.0.254** 
- Bình thường người ta hay chọn .1 vì tiện nhớ (10.10.0.1), 
- Gateway không được là `10.10.0.0` (network), không được là `10.10.0.255` (broadcast) và miễn không trùng với các container khác. 
https://docs.docker.com/reference/compose-file/networks/
https://www.warp.dev/terminus/docker-compose-networks

---
# soẹt 24 

```
networks:
  name-network:               # tên mạng bạn tạo
    driver: bridge              # kiểu mạng: bridge (mặc định của Docker)
    ipam:                       # IP Address Management - quản lý dải IP
      driver: default
      config:
        - subnet: 10.200.0.0/24 # dải mạng (CIDR) dùng cho network này
          gateway: 10.200.0.1   # địa chỉ gateway (cổng mặc định) của network
```

- Bạn đang tạo một mạng Docker tên **`intent-network`**.
    
- Mạng này có dải IP riêng: `10.200.0.0/24`.
    
- Docker sẽ cấp phát IP cho container trong dải này (ví dụ `10.200.0.2`, `10.200.0.3`…).
    
- Gateway (`10.200.0.1`) là “cầu nối” để container đi ra internet hoặc giao tiếp với host.

---

`/24` (soẹt 24) là cách viết tắt trong **CIDR notation** (Classless Inter-Domain Routing) để chỉ độ dài **subnet mask**.

- `/24` nghĩa là **24 bit đầu tiên** của địa chỉ IP dùng để xác định **network**, còn lại **8 bit cuối** để đánh số host.
    
- Subnet mask tương ứng là **255.255.255.0**.
    
- Như vậy, một mạng `/24` có thể chứa tối đa **256 địa chỉ IP** (từ `.0` đến `.255`), trong đó:
    
    - `.0` là địa chỉ network,
        
    - `.255` là địa chỉ broadcast,
        
    - còn lại ~254 địa chỉ dành cho host/container.
        

Ví dụ:

- `10.200.0.0/24` → dải IP khả dụng: `10.200.0.1` đến `10.200.0.254`.
    
- `192.168.1.0/24` → dải IP khả dụng: `192.168.1.1` đến `192.168.1.254`.
    

👉 Nếu bạn để `/16` thì sẽ có 65,534 IP khả dụng (quá rộng, dễ xung đột).  
👉 Với Docker, thường dùng `/24` để đủ chỗ cho vài container nhưng không chiếm nhiều dải IP.


---
# 4. Chú ý vấn đề: chồng lấn subnet  


Không được. Nếu hai file Docker Compose khai báo hai network với **cùng một subnet**, dù gateway khác, thì Docker vẫn báo lỗi "Pool overlaps with other one on this address space" và không cho phép tạo.[docker+2](https://docs.docker.com/reference/cli/docker/network/create/)

## Giải thích

- Docker yêu cầu các network không được sử dụng các subnet bị trùng hoặc chồng lấn nhau—even nếu gateway khác, subnet vẫn là phạm vi địa chỉ IP nên sẽ bị lỗi overlap.[thorsell+1](https://thorsell.io/2024/02/05/docker-network.html)
    
- Gateway chỉ là địa chỉ mặc định routing trong subnet, nhưng subnet thì đại diện cho toàn bộ dải địa chỉ mà network quản lý. Việc trùng subnet sẽ dẫn tới xung đột NAT/routing, nên gateway khác cũng không được phép.[stackoverflow+2](https://stackoverflow.com/questions/67674332/docker-network-bridge-overlapping-with-ip-addressing-used-for-the-vpn-clients-on)

- Nếu muốn có hai network riêng biệt, phải dùng hai subnet khác nhau, ví dụ:
    
    - Network A: `10.10.0.0/24`
        
    - Network B: `10.20.0.0/24`
        
- Gateway có thể đặt tùy ý trong mỗi subnet (nhưng không được trùng subnet).
    

Docker sẽ chỉ cho phép tạo nhiều network nếu subnet hoàn toàn không chồng lấn nhau, gateway không ảnh hưởng tới điều kiện này.[docker+2](https://docs.docker.com/reference/cli/docker/network/create/)

1. [https://docs.docker.com/reference/cli/docker/network/create/](https://docs.docker.com/reference/cli/docker/network/create/)
2. [https://thorsell.io/2024/02/05/docker-network.html](https://thorsell.io/2024/02/05/docker-network.html)
3. [https://stackoverflow.com/questions/67674332/docker-network-bridge-overlapping-with-ip-addressing-used-for-the-vpn-clients-on](https://stackoverflow.com/questions/67674332/docker-network-bridge-overlapping-with-ip-addressing-used-for-the-vpn-clients-on)
4. [https://forums.docker.com/t/docker-compose-multiple-networks/128718](https://forums.docker.com/t/docker-compose-multiple-networks/128718)
5. [https://stackoverflow.com/questions/38088279/communication-between-multiple-docker-compose-projects](https://stackoverflow.com/questions/38088279/communication-between-multiple-docker-compose-projects)
6. [https://www.reddit.com/r/docker/comments/ldkmry/how_to_run_two_docker_hosts_with_macvlan_on_the/](https://www.reddit.com/r/docker/comments/ldkmry/how_to_run_two_docker_hosts_with_macvlan_on_the/)
7. [https://docs.docker.com/compose/how-tos/networking/](https://docs.docker.com/compose/how-tos/networking/)
8. [https://www.netmaker.io/resources/docker-compose-network](https://www.netmaker.io/resources/docker-compose-network)
9. [https://github.com/moby/moby/issues/20179](https://github.com/moby/moby/issues/20179)
10. [https://docs.docker.com/engine/network/](https://docs.docker.com/engine/network/)
11. [https://github.com/moby/moby/issues/26912](https://github.com/moby/moby/issues/26912)
12. [https://forums.docker.com/t/network-with-255-255-255-255-as-subnet/79321](https://forums.docker.com/t/network-with-255-255-255-255-as-subnet/79321)
13. [https://stackoverflow.com/questions/50514275/docker-bridge-conflicts-with-host-network](https://stackoverflow.com/questions/50514275/docker-bridge-conflicts-with-host-network)
14. [https://philippmundhenk.github.io/Docker_IP_addresses/](https://philippmundhenk.github.io/Docker_IP_addresses/)


# 5. Summay Phân biệt 2 loại lỗi trên 

| Loại lỗi                 | Thông báo lỗi                                                                                              | Nguyên nhân                                                         | Ví dụ subnet                                                             | Giải pháp                                                                                                                                                                                                                                                                                                                              |
| ------------------------ | ---------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------- | ------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Hết dải network khả dụng | could not find an available, non-overlapping IPv4 address pool among the defaults to assign to the network | Docker đã dùng hết dải IP mặc định hoặc các subnet không còn đủ nhỏ | Có nhiều mạng/16chiếm gần hết 172.x.x.x, 192.168.x.x mặc định            | - Dùng một subnet hoàn toàn mới ngoài vùng đã bị Docker chiếm hết (ví dụ dùng dải10.x.x.x/24thay vì các dải mặc định) - Xóa bớt các network không sử dụng (docker network prunehoặcdocker network rm <network_name>) - Mở rộng/add thêm pools khả dụng trong/etc/docker/daemon.jsonvớidefault-address-pools, rồi restart Docker daemon |
| Chồng lấn (overlap)      | Pool overlaps with other one on this address space                                                         | Hai network dùng cùng hoặc chồng lấn subnet, dù gateway khác nhau   | A:10.10.0.0/24 B:10.10.0.0/24 Hoặc: A:10.10.0.0/16, B:10.10.1.0/24       | - Đổi sang subnet/dải IP chưa bị trùng hoặc chồng với network nào khác - Kiểm tra subnet các network hiện có trước khi khai báo mới bằngdocker network ls,docker network inspect - Xóa các network không còn cần dùng nếu bị trùng                                                                                                     |
Dưới đây là bảng **phân biệt các lỗi network thường gặp với Docker/Docker Compose** (hết dải subnet khả dụng và chồng lấn subnet) với giải pháp rõ ràng:

| **Loại lỗi**                   | **Thông báo lỗi**                                                                                                                                                              | **Nguyên nhân**                                                                       | **Ví dụ subnet**                                                                             | **Giải pháp**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| ------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Orphan containers**          | Found orphan containers for this project. If you removed or renamed this service in your compose file, you can run this command with the --remove-orphans flag to clean it up. | Service trong compose đang chạy không còn được định nghĩa trong compose file hiện tại | Có container `redis` chạy do compose file cũ, nhưng file hiện tại chỉ còn `api`              | - Nên dùng project name riêng biệt cho từng docker compose file (`-p <name>` hoặc `name:` trong compose file).  <br>- Không nên dùng `--remove-orphans` nếu còn muốn giữ containers từ file compose khác.  <br>- Start/stop từng compose với project name để tránh xung đột và orphan                                                                                                                                                                                                                                                        |
| **Hết dải network khả dụng**   | could not find an available, non-overlapping IPv4 address pool among the defaults to assign to the network                                                                     | Docker đã chiếm hết các dải IP mặc định hoặc subnet nhỏ còn lại không đủ              | Sau khi tạo rất nhiều mạng `/16` kiểu `172.x.x.x`, `192.168.x.x`                             | - Đổi sang dải subnet khác hoàn toàn, ví dụ `10.x.x.x/24`, `100.x.x.x/24`, không nằm trong các pool đã bị chiếm.  <br>- Xóa bớt các Docker network không dùng (`docker network prune` hoặc `docker network rm <network_name>`).  <br>- Mở rộng `default-address-pools` trong `/etc/docker/daemon.json`, rồi restart Docker daemon để có thêm dải IP mới.                                                                                                                                                                                     |
| **Chồng lấn subnet (overlap)** | Pool overlaps with other one on this address space                                                                                                                             | Hai network dùng cùng hoặc subnet bị chồng lấn nhau, dù gateway khác                  | A: `10.10.0.0/24`  <br>B: `10.10.0.0/24`  <br>Hoặc A: `10.10.0.0/16`,  <br>B: `10.10.1.0/24` | - Đổi subnet/dải IP khác hẳn, không chồng lấn với bất cứ docker network hiện có nào.  <br>- Kiểm tra các mạng hiện tại bằng `docker network ls`, `docker network inspect` để tránh bị trùng.  <br>- Nếu đang có mạng cũ bị thừa hoặc không dùng, hãy xóa nó trước khi tạo mạng mới để tránh overlap.<br>---<br>docker network ls -q \| xargs -n1 docker network inspect --format '{{.Name}}: {{range .IPAM.Config}}{{.Subnet}} (gw {{.Gateway}}){{end}}' \| grep '10.10.0.0/24'<br><br>---<br>docker network rm deploy_redis-network<br><br> |
|                                |                                                                                                                                                                                |                                                                                       |                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |


**Lưu ý:**

- Khi gặp lỗi "hết dải network", hoàn toàn có thể **dùng subnet mới**, miễn là subnet này chưa bị trùng hoặc nằm ngoài các dải pool đang bị lấp đầy bởi docker network khác.
    
- Sử dụng custom subnet như `10.x.x.x/24`, `100.x.x.x/24`… là giải pháp thực tiễn khi pool mặc định của Docker đã hết.
    
- "Chồng lấn" subnet là lỗi về logic mạng Docker — chỉ một subnet duy nhất được dùng, dù gateway có khác nhau cũng vẫn bị báo lỗi nếu overlap.
    

Bảng này giúp bạn xác định nhanh nguyên nhân và giải pháp cho các lỗi mạng phổ biến khi làm việc với Docker Compose và Docker network!

---
# Example best practices 

```bash
# Project name riêng cho API service
name: robot-workflow-project

services:
  api:
    build:
      context: ..
      dockerfile: ./deploy/Dockerfile.api
    container_name: robot-workflow-api
    restart: unless-stopped
    env_file:
      - .env
    environment:
      LOGGING_LEVEL: INFO
      ENVIRONMENT: local   # Tạm dùng local để tắt kafka đi
      HOST: 0.0.0.0
    ports:
      - "${PORT-30000}:30000"
    networks:
      - robot-workflow-network

networks:
  robot-workflow-network:               # tên mạng bạn tạo
    driver: bridge              # kiểu mạng: bridge (mặc định của Docker)
    ipam:                       # IP Address Management - quản lý dải IP
      driver: default
      config:
        - subnet: 10.10.0.0/24 # dải mạng (CIDR) dùng cho network này
          gateway: 10.10.0.1   # địa chỉ gateway (cổng mặc định) của network
```


```bash
# Project name riêng cho Redis services
name: robot-redis-project

services:
  redis:
    image: redis:latest
    container_name: robot-redis
    restart: unless-stopped
    command: redis-server --requirepass "yourStrongPassword" --appendonly yes --bind 0.0.0.0
    volumes:
      - redis-data:/data
    ports:
      - "30004:6379"
    networks:
      - robot-redis-network

  redisinsight:
    image: redislabs/redisinsight:latest
    container_name: robot-redisinsight
    restart: unless-stopped
    ports:
      - "29999:8001"
    networks:
      - robot-redis-network

volumes:
  redis-data:

networks:
  robot-redis-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.30.0.0/24
          gateway: 10.30.0.1
```


---
# BEST PRACTICES 


Dưới đây là **Best Practices toàn diện khi sử dụng Docker Compose** dựa trên các tiêu chuẩn 2025:

## 🔧 **1. Cấu trúc và Quản lý File**

## File Organization

text

`# Sử dụng version mới nhất (hoặc bỏ qua version field) version: "3.9"  # hoặc không cần khai báo # Đặt project name riêng để tránh conflict name: my-project services:   app:    # Service configuration`

## Multiple Environment Files[nickjanetakis+1](https://nickjanetakis.com/blog/best-practices-around-production-ready-web-apps-with-docker-compose)

bash

`# Base configuration docker-compose.yml  # Environment-specific overrides  docker-compose.dev.yml docker-compose.prod.yml docker-compose.test.yml`

Sử dụng:

bash

`# Development docker-compose -f docker-compose.yml -f docker-compose.dev.yml up # Production docker-compose -f docker-compose.yml -f docker-compose.prod.yml up`

## 🛡️ **2. Security Best Practices**

## Container Security[gitguardian+2](https://blog.gitguardian.com/how-to-improve-your-docker-containers-security-cheat-sheet/)

text

`services:   app:    image: node:18-alpine  # Sử dụng official images    user: "1000:1000"      # Non-root user    read_only: true        # Read-only filesystem    security_opt:      - no-new-privileges:true  # Ngăn privilege escalation    cap_drop:      - ALL                # Drop tất cả capabilities    cap_add:      - NET_BIND_SERVICE   # Chỉ add cần thiết`

## Secrets Management[dokploy+1](https://dokploy.com/fr/blog/how-to-deploy-apps-with-docker-compose-in-2025)

text

`# Không hardcode secrets trong compose file services:   app:    environment:      - DB_PASSWORD_FILE=/run/secrets/db_password    secrets:      - db_password secrets:   db_password:    external: true`

## 📊 **3. Resource Management và Performance**

## Resource Limits[cheatsheetseries.owasp+1](https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html)

text

`services:   app:    deploy:      resources:        limits:          memory: 1G          cpus: "0.5"        reservations:          memory: 512M          cpus: "0.25"`

## Health Checks[dev+1](https://dev.to/rajeshgheware/docker-compose-advanced-techniques-a-comprehensive-guide-to-production-deployments-1goi)

text

`services:   app:    healthcheck:      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]      interval: 30s      timeout: 10s      retries: 3      start_period: 60s`

## 🌐 **4. Networking Best Practices**

## Custom Networks[docker+1](https://docs.docker.com/compose/how-tos/networking/)

text

`services:   app:    networks:      - app-network  db:    networks:      - db-network      - app-network networks:   app-network:    driver: bridge  db-network:    driver: bridge    internal: true  # Database chỉ internal access`

## Port Management

text

`services:   app:    ports:      - "127.0.0.1:3000:3000"  # Bind to localhost only    # Thay vì expose tất cả interfaces:    # - "3000:3000"`

## 💾 **5. Volume và Data Management**

## Named Volumes[dev](https://dev.to/wallacefreitas/10-best-practices-for-writing-maintainable-docker-compose-files-4ca2)

text

`services:   db:    volumes:      - postgres_data:/var/lib/postgresql/data  # Named volume      - ./config:/etc/config:ro                 # Read-only mount volumes:   postgres_data:    driver: local`

## 🏗️ **6. Service Configuration**

## Service Dependencies[dev](https://dev.to/rajeshgheware/docker-compose-advanced-techniques-a-comprehensive-guide-to-production-deployments-1goi)

text

`services:   db:    healthcheck:      test: ["CMD-SHELL", "pg_isready -U postgres"]         app:    depends_on:      db:        condition: service_healthy  # Đợi DB healthy`

## Restart Policies

text

`services:   app:    restart: unless-stopped  # Recommended cho production     # restart: always          # Chỉ dùng khi cần container luôn chạy  # restart: "no"           # Development  # restart: on-failure     # Chỉ restart khi container fail`

## 🔍 **7. Environment Variables**

## Environment Management[docker](https://docs.docker.com/compose/how-tos/environment-variables/best-practices/)

text

`services:   app:    env_file:      - .env.common      - .env.local    environment:      - NODE_ENV=production      - DATABASE_URL=${DATABASE_URL}  # Interpolation`

## 🚀 **8. Production Readiness**

## Image Best Practices[talent500+1](https://talent500.com/blog/modern-docker-best-practices-2025/)

text

`services:   app:    image: myapp:1.2.3        # Specific version tags    # Không dùng: latest, :master         build:      context: .      dockerfile: Dockerfile.prod      target: production      # Multi-stage builds`

## Logging Configuration[dev](https://dev.to/rajeshgheware/docker-compose-advanced-techniques-a-comprehensive-guide-to-production-deployments-1goi)

text

`services:   app:    logging:      driver: "json-file"      options:        max-size: "10m"        max-file: "3"`

## 🔧 **9. Development vs Production**

## Development Override[reddit](https://www.reddit.com/r/docker/comments/13kxfjf/how_to_handle_dockercompose_for_production_and/)

text

`# docker-compose.dev.yml services:   app:    build:      target: development    volumes:      - .:/app              # Source code mounting      - /app/node_modules   # Anonymous volume    environment:      - NODE_ENV=development    command: npm run dev    # Development command`

## Production Override[reddit](https://www.reddit.com/r/docker/comments/13kxfjf/how_to_handle_dockercompose_for_production_and/)

text

`# docker-compose.prod.yml services:   app:    build:      target: production    restart: unless-stopped    read_only: true    security_opt:      - no-new-privileges:true`

## 📋 **10. Monitoring và Debugging**

## Service Monitoring[dev](https://dev.to/rajeshgheware/docker-compose-advanced-techniques-a-comprehensive-guide-to-production-deployments-1goi)

text

`services:   app:    labels:      - "traefik.enable=true"      - "monitoring.enabled=true"`

## 🚨 **11. Common Pitfalls to Avoid**

- ❌ Không sử dụng `latest` tag trong production
    
- ❌ Hardcode secrets trong compose file
    
- ❌ Chạy containers với root user
    
- ❌ Không set resource limits
    
- ❌ Expose ports trên tất cả interfaces (`0.0.0.0`)
    
- ❌ Không có health checks
    
- ❌ Dùng `--remove-orphans` mà không hiểu rõ hậu quả[stackoverflow](https://stackoverflow.com/questions/38088279/communication-between-multiple-docker-compose-projects)
    

## 📝 **12. Commands hay sử dụng**

bash

`# Development docker-compose up --build # Production  docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d # Monitoring docker-compose logs -f docker-compose ps docker-compose top # Cleanup docker-compose down --volumes --remove-orphans`

Những best practices này giúp đảm bảo Docker Compose applications của bạn **secure, scalable, maintainable và production-ready**.[docker+2](https://docs.docker.com/compose/how-tos/production/)

1. [https://nickjanetakis.com/blog/best-practices-around-production-ready-web-apps-with-docker-compose](https://nickjanetakis.com/blog/best-practices-around-production-ready-web-apps-with-docker-compose)
2. [https://dev.to/rajeshgheware/docker-compose-advanced-techniques-a-comprehensive-guide-to-production-deployments-1goi](https://dev.to/rajeshgheware/docker-compose-advanced-techniques-a-comprehensive-guide-to-production-deployments-1goi)
3. [https://blog.gitguardian.com/how-to-improve-your-docker-containers-security-cheat-sheet/](https://blog.gitguardian.com/how-to-improve-your-docker-containers-security-cheat-sheet/)
4. [https://www.aikido.dev/blog/a-no-bs-docker-security-checklist-for-the-vulnerability-minded-developer](https://www.aikido.dev/blog/a-no-bs-docker-security-checklist-for-the-vulnerability-minded-developer)
5. [https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html](https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html)
6. [https://dokploy.com/fr/blog/how-to-deploy-apps-with-docker-compose-in-2025](https://dokploy.com/fr/blog/how-to-deploy-apps-with-docker-compose-in-2025)
7. [https://docs.docker.com/compose/how-tos/environment-variables/best-practices/](https://docs.docker.com/compose/how-tos/environment-variables/best-practices/)
8. [https://talent500.com/blog/modern-docker-best-practices-2025/](https://talent500.com/blog/modern-docker-best-practices-2025/)
9. [https://docs.docker.com/compose/how-tos/networking/](https://docs.docker.com/compose/how-tos/networking/)
10. [https://www.warp.dev/terminus/docker-compose-networks](https://www.warp.dev/terminus/docker-compose-networks)
11. [https://dev.to/wallacefreitas/10-best-practices-for-writing-maintainable-docker-compose-files-4ca2](https://dev.to/wallacefreitas/10-best-practices-for-writing-maintainable-docker-compose-files-4ca2)
12. [https://www.reddit.com/r/docker/comments/13kxfjf/how_to_handle_dockercompose_for_production_and/](https://www.reddit.com/r/docker/comments/13kxfjf/how_to_handle_dockercompose_for_production_and/)
13. [https://stackoverflow.com/questions/38088279/communication-between-multiple-docker-compose-projects](https://stackoverflow.com/questions/38088279/communication-between-multiple-docker-compose-projects)
14. [https://docs.docker.com/compose/how-tos/production/](https://docs.docker.com/compose/how-tos/production/)
15. [https://www.bunnyshell.com/blog/is-docker-compose-production-ready/](https://www.bunnyshell.com/blog/is-docker-compose-production-ready/)
16. [https://thinksys.com/devops/docker-best-practices/](https://thinksys.com/devops/docker-best-practices/)
17. [https://www.youtube.com/watch?v=T--X3v2pwtU](https://www.youtube.com/watch?v=T--X3v2pwtU)
18. [https://collabnix.com/10-essential-docker-best-practices-for-r-developers-in-2025/](https://collabnix.com/10-essential-docker-best-practices-for-r-developers-in-2025/)
19. [https://betterstack.com/community/guides/scaling-docker/docker-security-best-practices/](https://betterstack.com/community/guides/scaling-docker/docker-security-best-practices/)
20. [https://news.ycombinator.com/item?id=32484008](https://news.ycombinator.com/item?id=32484008)
21. [https://docs.docker.com/build/building/best-practices/](https://docs.docker.com/build/building/best-practices/)
22. [https://www.reddit.com/r/selfhosted/comments/1aoujuu/best_security_practices_for_docker_containers/](https://www.reddit.com/r/selfhosted/comments/1aoujuu/best_security_practices_for_docker_containers/)
23. [https://docs.docker.com/engine/security/](https://docs.docker.com/engine/security/)